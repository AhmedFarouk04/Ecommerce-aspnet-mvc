@model ECommerce.Application.DTOs.ProductDto

@{
    ViewData["Title"] = Model.Name;
}

<style>
    
    .rating-stars i {
        font-size: 1.8rem;
        cursor: pointer;
        transition: color 0.2s ease-in-out;
    }

        .rating-stars i.hovered {
            color: gold !important;
        }

   
    .avg-stars i {
        font-size: 1.4rem;
        margin-right: 2px;
    }
</style>

<div class="container my-5">

    <div class="card-theme">

        <div class="row">

            
            <div class="col-lg-5 mb-4">
                @{
                    var mainImg =
                    !string.IsNullOrEmpty(Model.ImageUrl)
                    ? "/images/products/" + Model.ImageUrl
                    : !string.IsNullOrEmpty(Model.ThumbnailUrl)
                    ? "/images/products/" + Model.ThumbnailUrl
                    : "/images/no-image.png";
                }

                <img src="@mainImg" class="img-preview w-100" />
            </div>

            
            <div class="col-lg-7">

                <h2 class="fw-bold">@Model.Name</h2>

                <p class="text-muted mb-1">
                    Category: <span class="fw-bold">@Model.CategoryName</span>
                </p>

                <h3 class="text-success fw-bold mb-2">$@Model.Price</h3>

                @if (Model.AvailableStock > 10)
                {
                    <span class="badge bg-success mb-3">In Stock</span>
                }
                else if (Model.AvailableStock > 0)
                {
                    <span class="badge bg-warning text-dark mb-3">
                        Only @Model.AvailableStock left!
                    </span>
                }
                else
                {
                    <span class="badge bg-danger mb-3">Out of Stock</span>
                }



                
                <div class="mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="fw-semibold">Rating:</span>

                        <span id="avgRatingText">
                            @Model.AverageRating.ToString("0.0") / 5
                        </span>

                        <span class="text-muted small" id="ratingCountText">
                            (@Model.RatingCount @(Model.RatingCount == 1 ? "review" : "reviews"))
                        </span>
                    </div>

                    
                    <div class="avg-stars mt-1">
                        @for (int i = 1; i <= 5; i++)
                        {
                            var filled = Model.AverageRating >= i;
                            <i class="bi @(filled ? "bi-star-fill text-warning" : "bi-star text-secondary")"></i>
                        }
                    </div>
                </div>


                
                <div id="ratingSection" class="mb-4">
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <div class="rating-stars d-flex gap-1" data-current="@Model.UserRating.GetValueOrDefault(0)">
                            @for (var i = 1; i <= 5; i++)
                            {
                                var filled = Model.UserRating.HasValue && Model.UserRating.Value >= i;
                                <i class="bi @(filled ? "bi-star-fill text-warning" : "bi-star") rating-star"
                                   data-star="@i"></i>
                            }
                    </div>

                    <small class="text-muted d-block mt-1" id="ratingStatusText">
                        @(Model.UserRating.HasValue
                                                ? $"You rated this {Model.UserRating.Value} / 5"
                                                : "Click a star to rate this product.")
                    </small>
                                        }
                    else
                    {
                        <small class="text-muted">Login to rate this product.</small>
                    }
                </div>


                
                <p class="text-secondary mb-4">
                    High-quality selected product with guaranteed satisfaction.
                </p>

                
                <div class="d-flex gap-3 mb-4">

                    <button type="button"
                            class="btn-theme btn-primary-theme"
                            @(Model.AvailableStock == 0 ? "disabled" : "")
                            onclick="addToCartAjax(@Model.Id)">
                        <i class="bi bi-cart-plus"></i> Add to Cart
                    </button>



                    <a href="/Products" class="btn-theme btn-secondary-theme">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>

                </div>

                
                @if (User.IsInRole("Admin"))
                {
                    <div class="d-flex gap-2 mt-3">
                        <a href="/Products/Edit/@Model.Id" class="btn-theme btn-primary-theme">
                            <i class="bi bi-pencil-square"></i> Edit
                        </a>
                        <a href="/Products/Delete/@Model.Id" class="btn-theme btn-danger-theme">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </div>
                }

            </div>

        </div>

        <hr class="my-4" />

        
        <div class="row mb-4">
            <div class="col-lg-8">

                <h4 class="fw-semibold mb-3">Reviews</h4>

                <div id="reviewsContainer" class="mb-3"></div>

                @if (User.Identity?.IsAuthenticated == true)
                {
                    <form id="reviewForm" method="post">
                        @Html.AntiForgeryToken()

                        <div class="mb-2">
                            <label class="form-label fw-semibold">Write a review</label>
                            <textarea class="form-control" name="comment" rows="3"
                                  placeholder="Share your experience..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-sm btn-primary">
                            Submit Review
                        </button>

                        <small id="reviewFormStatus" class="text-muted ms-2"></small>
                    </form>
                }
                else
                {
                    <p class="text-muted">Login to write a review.</p>
                }

            </div>
        </div>

    </div>

</div>


<div class="modal fade" id="editReviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <form id="editReviewForm">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title">Edit Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <textarea class="form-control" id="editReviewText" rows="4"></textarea>
                    <input type="hidden" id="editReviewId" />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>

            </form>

        </div>
    </div>
</div>


@section Scripts {

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const stars = document.querySelectorAll(".rating-star");

            if (stars.length) {

                stars.forEach(s => {
                    s.addEventListener("mouseover", function () {
                        const val = parseInt(this.dataset.star);
                        stars.forEach(st => {
                            const stVal = parseInt(st.dataset.star);
                            if (stVal <= val) st.classList.add("hovered");
                            else st.classList.remove("hovered");
                        });
                    });

                    s.addEventListener("mouseleave", function () {
                        stars.forEach(st => st.classList.remove("hovered"));
                    });
                });

                stars.forEach(star => {
                    star.addEventListener("click", function () {

                        const selected = this.getAttribute("data-star");
                        const productId = @Model.Id;

                        fetch("/Ratings/Rate", {
                            method: "POST",
                            headers: { "Content-Type": "application/x-www-form-urlencoded" },
                            body: `productId=${productId}&stars=${selected}`
                        })
                        .then(r => r.json())
                        .then(data => {

                            if (!data.success) return;

                            stars.forEach(s => {
                                const starVal = parseInt(s.dataset.star);
                                if (starVal <= selected) {
                                    s.classList.add("bi-star-fill", "text-warning");
                                    s.classList.remove("bi-star");
                                } else {
                                    s.classList.add("bi-star");
                                    s.classList.remove("bi-star-fill", "text-warning");
                                }
                            });

                            document.getElementById("avgRatingText").textContent =
                                `${data.average.toFixed(1)} / 5`;

                            const label = data.count === 1 ? "review" : "reviews";
                            document.getElementById("ratingCountText").textContent =
                                `(${data.count} ${label})`;

                            document.getElementById("ratingStatusText").textContent =
                                `You rated this ${selected} / 5`;
                        });
                    });
                });
            }


           
            const productId = @Model.Id;
            const reviewsContainer = document.getElementById("reviewsContainer");

            function loadReviews() {
                fetch(`/Reviews/List?productId=${productId}`)
                    .then(r => r.json())
                    .then(items => {
                        reviewsContainer.innerHTML = "";

                        if (!items || !items.length) {
                            reviewsContainer.innerHTML = `<p class="text-muted">No reviews yet.</p>`;
                            return;
                        }

                        items.forEach(r => renderReview(r));
                    });
            }

            function renderReview(r) {

                const wrapper = document.createElement("div");
                wrapper.className = "border-start border-3 border-primary bg-light p-3 rounded mb-3 shadow-sm";

                wrapper.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${r.userName}</strong>
                            <small class="text-muted ms-2">${r.createdAt}</small>
                        </div>

                        ${r.isOwner ? `
                        <div>
                            <button class="btn btn-sm btn-outline-primary review-edit me-2" data-id="${r.id}" data-comment="${r.comment}">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger review-del" data-id="${r.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>` : ``}
                    </div>

                    <p class="mt-2 mb-0">${r.comment}</p>
                `;

                const del = wrapper.querySelector(".review-del");
                if (del) {
                    del.addEventListener("click", () => deleteReview(r.id, wrapper));
                }

                reviewsContainer.appendChild(wrapper);
            }

            function deleteReview(id, element) {
                const token = document.querySelector("#reviewForm input[name='__RequestVerificationToken']").value;

                fetch("/Reviews/Delete", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `id=${id}&__RequestVerificationToken=${token}`
                })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        element.remove();
                        if (!reviewsContainer.children.length)
                            reviewsContainer.innerHTML = `<p class="text-muted">No reviews yet.</p>`;
                    }
                });
            }

            loadReviews();


            
            const reviewForm = document.getElementById("reviewForm");

            if (reviewForm) {
                reviewForm.addEventListener("submit", e => {
                    e.preventDefault();

                    const comment = reviewForm.querySelector("textarea").value.trim();
                    const token = reviewForm.querySelector("input[name='__RequestVerificationToken']").value;
                    const status = document.getElementById("reviewFormStatus");

                    if (!comment) {
                        status.textContent = "Comment cannot be empty.";
                        return;
                    }

                    fetch("/Reviews/Add", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: `productId=${productId}&comment=${encodeURIComponent(comment)}&__RequestVerificationToken=${token}`
                    })
                    .then(r => r.json())
                    .then(res => {
                        if (!res.success) {
                            status.textContent = res.message || "Error submitting review.";
                            return;
                        }

                        status.textContent = "Review added.";
                        reviewForm.querySelector("textarea").value = "";
                        loadReviews();
                    });
                });
            }


            

            
            reviewsContainer.addEventListener("click", function (e) {
                if (e.target.closest(".review-edit")) {

                    const btn = e.target.closest(".review-edit");
                    const id = btn.dataset.id;
                    const comment = btn.dataset.comment;

                    document.getElementById("editReviewId").value = id;
                    document.getElementById("editReviewText").value = comment;

                    const modal = new bootstrap.Modal(document.getElementById("editReviewModal"));
                    modal.show();
                }
            });

           
            document.getElementById("editReviewForm").addEventListener("submit", function (e) {
                e.preventDefault();

                const id = document.getElementById("editReviewId").value;
                const comment = document.getElementById("editReviewText").value.trim();
                const token = document.querySelector("#editReviewForm input[name='__RequestVerificationToken']").value;

                if (!comment) return;

                fetch("/Reviews/Edit", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `id=${id}&comment=${encodeURIComponent(comment)}&__RequestVerificationToken=${token}`
                })
                .then(r => r.json())
                .then(res => {

                    if (res.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById("editReviewModal"));
                        modal.hide();
                        loadReviews();
                    }

                });
            });

        });
                  document.addEventListener("cart:updated", function (e) {

            const { productId, availableStock } = e.detail;

            if (productId !== @Model.Id) return;

            const badge = document.querySelector(".badge");
            const btn = document.querySelector("button[onclick^='addToCartAjax']");

            if (!badge || !btn) return;

            if (availableStock > 10) {
                badge.className = "badge bg-success mb-3";
                badge.textContent = "In Stock";
                btn.disabled = false;
            }
            else if (availableStock > 0) {
                badge.className = "badge bg-warning text-dark mb-3";
                badge.textContent = `Only ${availableStock} left!`;
                btn.disabled = false;
            }
            else {
                badge.className = "badge bg-danger mb-3";
                badge.textContent = "Out of Stock";
                btn.disabled = true;
            }
        });

    </script>
}
