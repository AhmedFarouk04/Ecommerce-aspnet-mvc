@model ProductListViewModel

<div class="row g-4">

    @if (!Model.Products.Any())
    {
        <div class="col-12 text-center py-5">
            <i class="bi bi-search fs-1 text-muted"></i>
            <h5 class="mt-3">No products found</h5>
            <p class="text-muted mb-0">
                Try adjusting your filters or search keywords.
            </p>
        </div>
    }
    else
    {
        foreach (var item in Model.Products)
        {
            <div class="col-sm-6 col-md-4 col-lg-3">

                <div class="card product-card h-100 position-relative"
                     data-product-id="@item.Id">

                    <button type="button"
                            class="wishlist-btn @(item.IsInWishlist ? "active" : "")"
                            aria-label="Toggle wishlist"
                            onclick="toggleWishlist(@item.Id, this)">
                        <i class="bi @(item.IsInWishlist ? "bi-heart-fill" : "bi-heart")"></i>
                    </button>

                    <img src="/images/products/@(item.ThumbnailUrl ?? item.ImageUrl ?? "no-image.png")"
                         class="card-img-top product-img"
                         alt="@item.Name"
                         loading="lazy" />

                    <div class="card-body d-flex flex-column">

                        <h6 class="fw-bold text-truncate mb-1" title="@item.Name">
                            @item.Name
                        </h6>

                        <small class="text-muted mb-2">@item.CategoryName</small>

                        <div class="d-flex align-items-center text-warning mb-2">
                            @if (item.RatingCount > 0)
                            {
                                for (int i = 1; i <= 5; i++)
                                {
                                    <i class="bi @(i <= Math.Round(item.AverageRating) ? "bi-star-fill" : "bi-star")"></i>
                                }
                                <small class="text-muted ms-1">(@item.RatingCount)</small>
                            }
                            else
                            {
                                <small class="text-muted">No ratings yet</small>
                            }
                        </div>

                        <div class="fw-bold text-success mb-2">$@item.Price</div>

                        @if (item.AvailableStock > 10)
                        {
                            <span class="badge bg-success mb-2 align-self-start product-stock-badge">
                                In Stock
                            </span>
                        }
                        else if (item.AvailableStock > 0)
                        {
                            <span class="badge bg-warning text-dark mb-2 align-self-start product-stock-badge">
                                Only @item.AvailableStock left
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-danger mb-2 align-self-start product-stock-badge">
                                Out of Stock
                            </span>
                        }

                        <div class="mt-auto d-grid gap-2">

                            <a href="/Products/Details/@item.Id"
                               class="btn btn-outline-primary btn-sm">
                                View
                            </a>

                            <button class="btn btn-primary btn-sm add-to-cart-btn"
                                    @(item.AvailableStock == 0 ? "disabled" : "")
                                    onclick="addToCartAjax(@item.Id)">
                                <i class="bi bi-cart-plus"></i> Add to Cart
                            </button>

                            @if (User.IsInRole("Admin"))
                            {
                                <div class="d-flex gap-2">
                                    <a href="/Products/Edit/@item.Id"
                                       class="btn btn-warning btn-sm w-50">
                                        Edit
                                    </a>
                                    <a href="/Products/Delete/@item.Id"
                                       class="btn btn-danger btn-sm w-50">
                                        Delete
                                    </a>
                                </div>
                            }
                        </div>

                    </div>
                </div>
            </div>
        }
    }
</div>

@if (Model.TotalPages > 1)
{
    <nav class="mt-4">
        <ul class="pagination justify-content-center">

            @{
                var prevPage = Model.CurrentPage - 1;
                var nextPage = Model.CurrentPage + 1;
            }

            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link"
                   href="#"
                   data-page="@(prevPage < 1 ? 1 : prevPage)">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                    <a class="page-link"
                       href="#"
                       data-page="@i">
                        @i
                    </a>
                </li>
            }

            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                <a class="page-link"
                   href="#"
                   data-page="@(nextPage > Model.TotalPages ? Model.TotalPages : nextPage)">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>

        </ul>
    </nav>
}



<script>
    function toggleWishlist(productId, btn) {

        const isActive = btn.classList.contains("active");
        const url = isActive ? "/Wishlist/Remove" : "/Wishlist/Add";

        fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "productId=" + encodeURIComponent(productId)
        })
        .then(res => res.json())
        .then(res => {

            if (!res || res.success !== true) {
                showToast?.("Please login to manage wishlist.", "warning");
                return;
            }

            btn.classList.toggle("active");
            btn.innerHTML = btn.classList.contains("active")
                ? `<i class="bi bi-heart-fill"></i>`
                : `<i class="bi bi-heart"></i>`;
        })
        .catch(() => {
            showToast?.("Something went wrong.", "danger");
        });
    }
</script>
