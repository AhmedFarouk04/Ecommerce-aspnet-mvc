@model IEnumerable<ECommerce.Web.ViewModels.AdminReviewViewModel>

@{
    ViewData["Title"] = "Reviews Management";
    Layout = "~/Views/Admin/_AdminLayout.cshtml";
}

<div class="container my-5">

    <h2 class="fw-bold mb-4">
        <i class="bi bi-chat-left-text text-primary"></i> Reviews Management
    </h2>

    <form method="get" class="mb-3">
        <div class="input-group">
            <input type="text"
                   name="search"
                   class="form-control"
                   value="@ViewBag.Search"
                   placeholder="Search comments, users, products..." />
            <button class="btn btn-primary">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </form>

    <div class="card shadow-sm p-4">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Product</th>
                        <th>User</th>
                        <th>Comment</th>
                        <th>Date</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var r in Model)
                    {
                        <tr>
                            <td>@r.Id</td>

                            <td>
                                <img src="/images/products/@(r.ProductThumbnail ?? "no-image.png")"
                                     width="45" height="45"
                                     class="rounded"
                                     style="object-fit:cover" />

                                <a class="ms-2 fw-bold"
                                   href="/Products/Details/@r.ProductId">
                                    @r.ProductName
                                </a>
                            </td>

                            <td>
                                <img src="/images/users/@(r.UserThumbnail ?? "default.png")"
                                     width="40" height="40"
                                     class="rounded-circle"
                                     style="object-fit:cover" />

                                <span class="ms-2">@r.UserName</span>
                            </td>

                            <td>@r.Comment</td>

                            <td>@r.CreatedAtFormatted</td>

                            <td class="text-end">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteReviewModal"
                                        data-review-id="@r.Id">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <nav>
            <ul class="pagination justify-content-center mt-3">
                @{
                    int current = ViewBag.CurrentPage;
                    int total = ViewBag.TotalPages;

                    for (int i = 1; i <= total; i++)
                    {
                        <li class="page-item @(i == current ? "active" : "")">
                            <a class="page-link"
                               href="?page=@i&search=@ViewBag.Search">
                                @i
                            </a>
                        </li>
                    }
                }
            </ul>
        </nav>

    </div>
</div>

<div class="modal fade" id="deleteReviewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle"></i> Confirm Delete
                </h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                Are you sure you want to delete this review?
                <br />
                <small class="text-muted">
                    This action cannot be undone.
                </small>
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Cancel
                </button>

                <form method="post"
                      asp-action="Delete"
                      asp-controller="AdminReviews">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="deleteReviewId" />

                    <button type="submit"
                            class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        const deleteModal = document.getElementById('deleteReviewModal');

        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const reviewId = button.getAttribute('data-review-id');
            document.getElementById('deleteReviewId').value = reviewId;
        });
    </script>
}
